# SPDX-License-Identifier: MIT OR AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2024-2025 hyperpolymath
#
# Full Nginx server block with well-known resources
# Copy and customize for your site

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name example.com www.example.com;

    # SSL configuration
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # Security headers
    add_header Strict-Transport-Security "max-age=63072000" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;

    root /var/www/example.com;
    index index.html;

    # Well-known directory
    location /.well-known/ {
        alias /var/www/example.com/.well-known/;
        default_type text/plain;

        # JSON resources
        location ~ \.json$ {
            default_type application/json;
        }

        # Apple App Site Association (no extension)
        location = /.well-known/apple-app-site-association {
            default_type application/json;
        }

        # OpenID Configuration
        location = /.well-known/openid-configuration {
            default_type application/json;
        }

        # Matrix server discovery
        location = /.well-known/matrix/server {
            default_type application/json;
        }

        location = /.well-known/matrix/client {
            default_type application/json;
            # CORS for Matrix clients
            add_header Access-Control-Allow-Origin "*";
        }

        # WebFinger
        location = /.well-known/webfinger {
            default_type application/jrd+json;
            # CORS for federation
            add_header Access-Control-Allow-Origin "*";
        }

        # NodeInfo
        location = /.well-known/nodeinfo {
            default_type application/json;
            add_header Access-Control-Allow-Origin "*";
        }
    }

    # Redirect from /security.txt to /.well-known/security.txt
    location = /security.txt {
        return 301 /.well-known/security.txt;
    }

    # Main site
    location / {
        try_files $uri $uri/ =404;
    }
}

# HTTP to HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name example.com www.example.com;
    return 301 https://$server_name$request_uri;
}
